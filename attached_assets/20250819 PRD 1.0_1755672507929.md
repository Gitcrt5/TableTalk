# TableTalk Complete Specification v4.0 — Enhanced Bridge Platform with Flexible Event Management

This comprehensive specification integrates the core TableTalk platform with enhanced workflows for both formal duplicate tournaments and casual bridge club sessions, incorporating insights from real-world bridge club operations.

---

## 1) Overview

### 1.1 Purpose

TableTalk is a web platform for bridge players to create and review games, analyze boards, practice bidding, and discuss hands with partners and the community. It supports the full spectrum of bridge play from formal duplicate tournaments to casual club sessions and educational practice sets.

### 1.2 Target Audience

- Bridge players of all skill levels (formal duplicate to casual social)
- Bridge clubs (duplicate clubs, social clubs, teaching clubs)  
- Bridge teachers and students
- Partnerships seeking collaborative analysis
- Users with limited technical skills (UX optimized for simplicity)

### 1.3 Key Value Propositions

- **Efficient Event Management**: Single hand record upload serves multiple participants
- **Flexible Participation**: Support both formal tournaments and casual sessions
- **Collaborative Learning**: Partnership and community analysis tools
- **Self-Paced Engagement**: Players control their level of participation
- **Educational Focus**: Compare actual play with optimal results
- **Archive Building**: Creates searchable library of interesting deals over time

### 1.4 Core Concepts

- **User**: A registered participant in the app
- **Club**: An organization that may host events and be associated to games
- **Event**: A club-created collection of bridge deals that can be adopted by multiple games. Events can be formal (with pair numbers) or casual (open registration)
- **Event Deals**: Canonical deal data (hands, dealer, vulnerability, optimal results) shared across all games in an event
- **Game**: A user-owned record linking to an event or containing standalone boards, with user-specific data (bidding, results, comments)
- **Board**: A game-specific instance that references event deal data plus user-entered bidding, contract, results, and comments
- **Participant**: A person associated with a game instance. Can be a registered user or named external person
- **Partnership**: A player's address-book style link to another player for discovery and quick selection

---

## 2) Principles and Decisions

1. **Shared event data**: Event deals stored once and referenced by multiple games for efficiency
2. **Flexible participation**: Support both formal tournaments and casual sessions without forcing structure
3. **Player-driven engagement**: Users choose their level of participation and data sharing
4. **Educational focus**: Emphasize learning and improvement over competition
5. **Self-paced analysis**: Players can report results for boards they found interesting
6. **Community resource**: All hand records available for study and discussion
7. **Optional engagement**: Players can use as much or as little as they want
8. **PBN focus**: Use analysis contained in PBN only. No solver in MVP
9. **Bidding validation**: Strict legality checks with Undo and Clear for corrections
10. **Mobile-first**: Optimized for in-play use with predictable controls
11. **Privacy flexibility**: Games public by default, granular privacy in future phases
12. **Soft deletion**: Maintain data integrity with is_deleted flags

---

## 3) Enhanced Scope and Acceptance Criteria

### 3.1 Authentication (Firebase)
- Users register and sign in with Firebase
- Backend verifies ID tokens for API access
- Admin bootstrap via environment secrets

### 3.2 Comprehensive Event Management

#### 3.2.1 Event Types and Registration Models
- **Formal tournaments**: Traditional duplicate with pair numbers, official results, competitive focus
- **Casual club sessions**: Open registration, flexible seating, learning focus, optional result sharing
- **Practice sets**: Curated hands for education, minimal structure, self-paced study
- **Teaching events**: Instructor-led with guided analysis and discussion

#### 3.2.2 Club Event Administration
- **Event Creation**: Club admins create events with flexible registration types and properties
- **Hand Record Management**: Single PBN upload creates shared event deals for all participants
- **Publication Control**: Events published when ready for player adoption
- **Minimal Setup**: Focus on core function (deals) rather than administrative overhead
- **Post-Game Upload**: Events can be created after games complete, supporting casual workflows

#### 3.2.3 Event Data Architecture
- **Canonical Deals**: Hand data, dealer, vulnerability, optimal results stored once per event
- **Automatic Propagation**: Deal corrections update all linked games instantly
- **Storage Efficiency**: 90%+ reduction in data duplication for popular events
- **Performance Optimization**: Strategic indexing for fast queries across shared data

### 3.3 Flexible Game Management

#### 3.3.1 Event-Based Game Creation
- **Formal Events**: Select pair number and direction (NS/EW) from available options
- **Casual Events**: Enter session identifier ("Table 3", "Morning game") or remain anonymous
- **Practice Events**: Simple adoption with immediate access to deals
- **Teaching Events**: Student registration with instructor guidance

#### 3.3.2 Standalone Game Creation  
- **Traditional Workflow**: Create games without events for personal use
- **Direct PBN Upload**: Hand records stored in game-specific boards
- **Full Backward Compatibility**: All existing functionality preserved
- **Partnership Integration**: Easy partner nomination via address-book partnerships

#### 3.3.3 Participant Management
- **Flexible Registration**: Support both registered users and external partners
- **Role-Based Access**: Owner, player, teacher, viewer roles with appropriate permissions
- **Partner Integration**: Quick selection from partnership address book
- **Edit Rights Management**: Configurable permissions for collaborative analysis

### 3.4 Enhanced Board Analysis and Learning

#### 3.4.1 Multi-Source Deal Display
- **Event Deal Integration**: Automatic display of shared deal data when available
- **Standalone Board Data**: Game-specific deal storage for non-event games
- **Optimal Results**: Display par contracts and double-dummy analysis when available
- **Hand Analysis**: HCP calculations and distribution analysis computed once per event

#### 3.4.2 User Data Entry and Tracking
- **Selective Reporting**: Players can choose which boards to analyze and report
- **Complete Analysis**: Bidding sequences, contracts, play results, strategic notes
- **Performance Tracking**: Score comparison with optimal results and other participants
- **Learning Focus**: Emphasis on improvement rather than formal scoring

#### 3.4.3 Comparative Analysis Tools
- **Cross-Game Comparison**: See how other participants played the same boards
- **Anonymous Options**: Privacy-friendly result sharing for comfortable learning
- **Statistical Insights**: Result distributions, success rates, common approaches
- **Community Learning**: Learn from different players' approaches to same hands

### 3.5 Advanced Discussion and Collaboration

#### 3.5.1 Multi-Level Comment System
- **Board-Specific Comments**: Private to individual games, partnership collaboration
- **Event-Wide Discussions**: Comments visible across all games from the event
- **Privacy Controls**: Private, partnership, club, and public visibility levels
- **Comment Types**: Analysis, questions, teaching notes with appropriate categorization

#### 3.5.2 Enhanced Learning Features
- **Strategic Annotations**: Detailed analysis of bidding and play decisions
- **Question and Answer**: Community support for learning and improvement
- **Teaching Integration**: Instructor guidance and student discussion features
- **Knowledge Archive**: Searchable history of deals and analysis over time

### 3.6 Bidding Entry and Validation

- **Comprehensive Bidding Pad**: Support for Pass, X, XX, and all standard bids
- **Strict Legality Enforcement**: Prevent illegal bids with clear explanations
- **Error Recovery**: Undo and Clear functions for correcting mistakes
- **Mobile Optimization**: Fixed controls that don't move during sequence entry
- **Sequence Recording**: Complete auction history with position tracking

### 3.7 Club and Community Management

#### 3.7.1 Club Administration
- **Club Creation**: Admin tools for establishing club presence
- **Event Management**: Create, publish, and manage events for club members
- **Member Integration**: Optional club membership with directory features
- **Community Building**: Tools for fostering learning and collaboration

#### 3.7.2 Partnership and Social Features
- **Partnership Address Book**: Maintain connections with regular partners
- **Partner Discovery**: Find players for collaboration and learning
- **Social Learning**: Community discussions and knowledge sharing
- **Mentorship Support**: Connect experienced and learning players

### 3.8 Administration and Moderation

#### 3.8.1 User and Content Management
- **User Administration**: Manage accounts, roles, and permissions
- **Content Moderation**: Tools for maintaining community standards
- **Data Integrity**: Automated consistency checks and repair tools
- **Performance Monitoring**: System health and usage analytics

#### 3.8.2 Platform Maintenance
- **Feature Flags**: Controlled rollout of new functionality
- **Audit Logging**: Track important actions for security and debugging
- **Error Handling**: Comprehensive error reporting and resolution
- **Backup and Recovery**: Data protection and disaster recovery

### 3.9 Notifications and Real-Time Updates

- **In-App Messaging**: Success, error, and informational messages
- **Real-Time Refresh**: Updates for new comments and status changes
- **Rate Limiting**: Spam protection and system resource management
- **Progress Indicators**: Feedback for long-running operations like PBN import

---

## 4) Enhanced User Stories

### 4.1 Club Administration Stories
- As a club admin, I can create upcoming events with dates, name, location with final details to be added once the game is complete
- As a club admin, I can create events after our games complete by uploading the hand record
- As a club admin, I can support both formal duplicate nights and casual bridge sessions
- As a club admin, I can upload one PBN file and have it automatically available to all participants
- As a club admin, I can correct deal errors and have changes appear in all participant games
- As a club admin, I can publish events when ready without requiring advance registration

### 4.2 Player Engagement Stories
- As a player, I can browse available events and understand the participation requirements
- As a player, I can claim participation in formal events by selecting my pair and direction
- As a player, I can participate in casual events by describing my session or remaining anonymous
- As a player, I can selectively report results for boards I found interesting or challenging
- As a player, I can study any board from any event whether I participated or not
- As a player, I can add strategic analysis and questions for community learning

### 4.3 Learning and Analysis Stories
- As a player, I can compare my results with optimal play from double-dummy analysis
- As a player, I can see how other participants approached the same hands
- As a player, I can engage in board-specific discussions with my partner
- As a player, I can participate in event-wide discussions visible to all participants
- As a player, I can track my performance and improvement over time
- As a player, I can build a personal archive of interesting deals and analysis

### 4.4 Community and Education Stories
- As a bridge teacher, I can create practice events with curated deals for my students
- As a student, I can access instructor commentary and participate in guided discussions
- As a community member, I can contribute to the collective knowledge about interesting deals
- As a learner, I can search the archive for similar deals and study different approaches

---

## 5) Comprehensive Data Model

### 5.1 Enhanced Entity Relationship Overview

- **users** (1) ← (M) **games** (ownership and participation)
- **users** (M) ← (M) **users** via **partnerships** (directional address book)
- **clubs** (1) ← (M) **events** (event hosting)
- **events** (1) ← (M) **event_deals** (canonical shared deal data)
- **events** (1) ← (M) **games** (optional event linkage)
- **games** (1) ← (M) **game_participants** (flexible participation model)
- **games** (1) ← (M) **boards** (game-specific instances)
- **boards** (M) → (1) **event_deals** (optional reference to shared data)
- **boards** (1) ← (M) **comments** (board-specific discussions)
- **event_deals** (1) ← (M) **comments** (event-wide discussions)
- **users** (1) ← (M) **comments** (comment ownership)
- **users** (M) ← (M) **clubs** via **favourite_clubs** (club membership)
- **events** (1) ← (M) **event_results** (comparative analysis data)

### 5.2 Complete PostgreSQL Schema

```sql
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Core reference tables
CREATE TABLE user_types (
  user_type_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  code TEXT UNIQUE NOT NULL,
  label TEXT NOT NULL,
  description TEXT,
  created_at TIMESTAMPTZ DEFAULT now()
);

INSERT INTO user_types (code, label, description) VALUES 
  ('player', 'Player', 'Standard bridge player'),
  ('teacher', 'Teacher', 'Bridge instructor with teaching tools'),
  ('admin', 'Administrator', 'Platform administrator'),
  ('moderator', 'Moderator', 'Community moderator'),
  ('test', 'Test User', 'Test account for development');

-- Club management
CREATE TABLE clubs (
  club_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  description TEXT,
  country TEXT NOT NULL,
  state TEXT NOT NULL,
  city TEXT,
  website TEXT,
  email TEXT,
  phone TEXT,
  address TEXT,
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- User management with enhanced profile
CREATE TABLE users (
  user_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  email TEXT UNIQUE NOT NULL,
  firebase_uid TEXT UNIQUE NOT NULL,
  first_name TEXT,
  last_name TEXT,
  display_name TEXT,
  home_club_id UUID REFERENCES clubs(club_id),
  user_type_id UUID REFERENCES user_types(user_type_id),
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  last_login TIMESTAMPTZ,
  preferences JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- Club membership and favorites
CREATE TABLE favourite_clubs (
  user_id UUID REFERENCES users(user_id) ON DELETE CASCADE,
  club_id UUID REFERENCES clubs(club_id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT now(),
  PRIMARY KEY (user_id, club_id)
);

-- Type definitions for enhanced flexibility
CREATE TYPE game_type AS ENUM ('USER','CLUB');
CREATE TYPE visibility_type AS ENUM ('private','link','public');
CREATE TYPE event_status AS ENUM ('draft','published','closed','archived');
CREATE TYPE event_kind AS ENUM ('club_session','practice_set','casual_play','tournament','teaching');
CREATE TYPE registration_type AS ENUM ('formal_pairs','open_registration','invite_only');
CREATE TYPE pair_side_type AS ENUM ('NS','EW','Unknown');
CREATE TYPE game_role AS ENUM ('owner','player','teacher','viewer');
CREATE TYPE seat_type AS ENUM ('N','E','S','W');
CREATE TYPE comment_type AS ENUM ('analysis','question','teaching','general');

-- Enhanced events with flexible registration and post-game support
CREATE TABLE events (
  event_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  club_id UUID REFERENCES clubs(club_id) ON DELETE SET NULL,
  name TEXT NOT NULL,
  description TEXT,
  date DATE,
  kind event_kind NOT NULL DEFAULT 'club_session',
  board_count INTEGER CHECK (board_count >= 1),
  pbn_raw TEXT,
  visibility visibility_type NOT NULL DEFAULT 'public',
  status event_status NOT NULL DEFAULT 'draft',
  
  -- Flexible registration and participation
  registration_type registration_type NOT NULL DEFAULT 'open_registration',
  movement_type TEXT, -- 'Mitchell', 'Howell', 'Swiss', 'Casual', etc.
  session_type TEXT, -- 'Morning', 'Afternoon', 'Evening'
  entry_deadline TIMESTAMPTZ,
  max_pairs INTEGER,
  
  -- Event behavior and features
  enable_comparative_scoring BOOLEAN DEFAULT TRUE,
  allow_anonymous_games BOOLEAN DEFAULT TRUE,
  enable_event_discussions BOOLEAN DEFAULT TRUE,
  auto_publish_results BOOLEAN DEFAULT FALSE,
  
  -- Post-game creation support
  created_after_game BOOLEAN DEFAULT FALSE,
  game_completion_date DATE,
  
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- Canonical deal data shared across all event games
CREATE TABLE event_deals (
  event_deal_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  event_id UUID NOT NULL REFERENCES events(event_id) ON DELETE CASCADE,
  board_number INTEGER NOT NULL CHECK (board_number >= 1),
  dealer CHAR(1) CHECK (dealer IN ('N','E','S','W')),
  vulnerability TEXT,
  north_hand TEXT NOT NULL,
  east_hand TEXT NOT NULL, 
  south_hand TEXT NOT NULL,
  west_hand TEXT NOT NULL,
  
  -- Optimal play analysis from PBN
  optimum_info JSONB,
  par_contract TEXT,
  par_score INTEGER,
  
  -- Computed analysis (cached for performance)
  hand_analysis JSONB, -- HCP, distribution, shape analysis
  
  -- Deal quality and educational value
  deal_notes TEXT,
  educational_tags TEXT[], -- 'slam', 'sacrifice', 'competitive', etc.
  
  created_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE (event_id, board_number)
);

-- Enhanced games supporting both event-linked and standalone workflows
CREATE TABLE games (
  game_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  owner_user_id UUID REFERENCES users(user_id) ON DELETE SET NULL,
  event_id UUID REFERENCES events(event_id) ON DELETE SET NULL,
  
  -- Flexible event participation
  pair_number INTEGER, -- NULL for casual/unregistered games
  table_number INTEGER,
  direction CHAR(2) CHECK (direction IN ('NS','EW')),
  session_identifier TEXT, -- For casual games: "Table 3", "Morning session", etc.
  
  -- Game metadata
  name TEXT NOT NULL,
  description TEXT,
  date DATE NOT NULL,
  board_count INTEGER CHECK (board_count >= 1),
  club_id UUID REFERENCES clubs(club_id),
  location TEXT,
  type game_type NOT NULL DEFAULT 'USER',
  
  -- Standalone game data (NULL when linked to event)
  pbn_raw TEXT,
  
  -- Game behavior and privacy
  visibility visibility_type NOT NULL DEFAULT 'public',
  allow_comments BOOLEAN DEFAULT TRUE,
  enable_comparative_analysis BOOLEAN DEFAULT TRUE,
  
  -- Administrative
  is_deleted BOOLEAN NOT NULL DEFAULT FALSE,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  
  -- Ensure proper event participation
  CONSTRAINT event_game_participation CHECK (
    (event_id IS NULL) OR 
    (event_id IS NOT NULL AND (pair_number IS NOT NULL OR session_identifier IS NOT NULL))
  ),
  
  -- Ensure PBN is only stored for standalone games
  CONSTRAINT standalone_pbn CHECK (
    (event_id IS NULL AND pbn_raw IS NOT NULL) OR
    (event_id IS NOT NULL AND pbn_raw IS NULL) OR
    (event_id IS NULL AND pbn_raw IS NULL)
  )
);

-- Flexible participation model supporting various roles and identification
CREATE TABLE game_participants (
  game_participant_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  game_id UUID NOT NULL REFERENCES games(game_id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(user_id) ON DELETE SET NULL,
  display_name TEXT,
  role game_role NOT NULL DEFAULT 'player',
  seat seat_type,
  pair_side pair_side_type DEFAULT 'Unknown',
  invite_email TEXT,
  is_editor BOOLEAN NOT NULL DEFAULT TRUE,
  notes TEXT, -- Partnership notes, preferences, etc.
  created_at TIMESTAMPTZ DEFAULT now(),
  
  -- Ensure participant identification
  CONSTRAINT participant_identity CHECK (
    user_id IS NOT NULL OR display_name IS NOT NULL OR invite_email IS NOT NULL
  )
);

-- Ensure unique user participation per game
CREATE UNIQUE INDEX uniq_game_user_participant
  ON game_participants(game_id, user_id) WHERE user_id IS NOT NULL;

-- Ensure exactly one owner per game
CREATE UNIQUE INDEX uniq_game_owner
  ON game_participants(game_id) WHERE role = 'owner';

-- Enhanced boards supporting both shared event data and standalone storage
CREATE TABLE boards (
  board_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  game_id UUID NOT NULL REFERENCES games(game_id) ON DELETE CASCADE,
  board_number INTEGER NOT NULL CHECK (board_number >= 1),
  
  -- Link to shared event deal data
  event_deal_id UUID REFERENCES event_deals(event_deal_id),
  
  -- Standalone deal data (when not linked to event)
  dealer CHAR(1),
  vulnerability TEXT,
  north_hand TEXT,
  east_hand TEXT,
  south_hand TEXT,
  west_hand TEXT,
  optimum_info JSONB,
  
  -- User-entered data (always game-specific)
  bidding JSONB,
  contract TEXT,
  declarer CHAR(1),
  lead_card TEXT,
  tricks_taken INTEGER,
  notes TEXT,
  
  -- Performance and analysis
  score INTEGER,
  percentage DECIMAL(5,2),
  matchpoints DECIMAL(8,2),
  
  -- User analysis and annotations
  bidding_notes TEXT,
  play_notes TEXT,
  learning_points TEXT,
  
  -- Board metadata
  is_analyzed BOOLEAN DEFAULT FALSE,
  analysis_quality INTEGER CHECK (analysis_quality BETWEEN 1 AND 5),
  
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  
  UNIQUE (game_id, board_number),
  
  -- Ensure deal data availability from either source
  CONSTRAINT board_deal_data CHECK (
    (event_deal_id IS NOT NULL) OR 
    (north_hand IS NOT NULL AND east_hand IS NOT NULL AND 
     south_hand IS NOT NULL AND west_hand IS NOT NULL)
  )
);

-- Comparative analysis and result tracking
CREATE TABLE event_results (
  event_result_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  event_id UUID NOT NULL REFERENCES events(event_id) ON DELETE CASCADE,
  board_number INTEGER NOT NULL,
  
  -- Flexible participant identification
  pair_number INTEGER,
  game_id UUID REFERENCES games(game_id),
  session_identifier TEXT,
  direction CHAR(2),
  
  -- Result data
  contract TEXT,
  declarer CHAR(1),
  lead_card TEXT,
  tricks_taken INTEGER,
  score INTEGER,
  
  -- Metadata and privacy
  submitted_by UUID REFERENCES users(user_id),
  is_anonymous BOOLEAN DEFAULT FALSE,
  result_confidence INTEGER CHECK (result_confidence BETWEEN 1 AND 5),
  
  created_at TIMESTAMPTZ DEFAULT now(),
  
  -- Ensure result identification
  CONSTRAINT result_identification CHECK (
    pair_number IS NOT NULL OR game_id IS NOT NULL OR session_identifier IS NOT NULL
  ),
  
  -- Prevent duplicate results
  UNIQUE NULLS NOT DISTINCT (event_id, board_number, pair_number, direction),
  UNIQUE (event_id, board_number, game_id) WHERE pair_number IS NULL
);

-- Event standings and leaderboards
CREATE TABLE event_standings (
  event_standing_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  event_id UUID NOT NULL REFERENCES events(event_id) ON DELETE CASCADE,
  pair_number INTEGER,
  game_id UUID REFERENCES games(game_id),
  session_identifier TEXT,
  direction CHAR(2),
  
  -- Performance metrics
  total_matchpoints DECIMAL(8,2),
  percentage DECIMAL(5,2),
  position INTEGER,
  boards_played INTEGER DEFAULT 0,
  games_linked INTEGER DEFAULT 0,
  
  -- Statistical analysis
  average_score DECIMAL(8,2),
  boards_above_average INTEGER DEFAULT 0,
  best_result_board INTEGER,
  worst_result_board INTEGER,
  
  updated_at TIMESTAMPTZ DEFAULT now(),
  
  -- Flexible uniqueness constraints
  UNIQUE NULLS NOT DISTINCT (event_id, pair_number, direction),
  UNIQUE (event_id, game_id) WHERE pair_number IS NULL
);

-- Enhanced multi-level comment system
CREATE TABLE comments (
  comment_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  
  -- Comments target either specific boards or event deals
  board_id UUID REFERENCES boards(board_id) ON DELETE CASCADE,
  event_deal_id UUID REFERENCES event_deals(event_deal_id) ON DELETE CASCADE,
  
  user_id UUID NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
  body TEXT NOT NULL,
  
  -- Comment classification and behavior
  comment_type comment_type DEFAULT 'analysis',
  visibility visibility_type DEFAULT 'public',
  
  -- Thread support for discussions
  parent_comment_id UUID REFERENCES comments(comment_id) ON DELETE CASCADE,
  thread_depth INTEGER DEFAULT 0 CHECK (thread_depth >= 0),
  
  -- Moderation and quality
  is_flagged BOOLEAN NOT NULL DEFAULT FALSE,
  flagged_reason TEXT,
  flag_count INTEGER DEFAULT 0,
  is_deleted BOOLEAN NOT NULL DEFAULT FALSE,
  
  -- Learning and teaching support
  is_educational BOOLEAN DEFAULT FALSE,
  teaching_level TEXT CHECK (teaching_level IN ('beginner', 'intermediate', 'advanced')),
  
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  
  -- Ensure comment has exactly one target
  CONSTRAINT comment_target CHECK (
    (board_id IS NOT NULL AND event_deal_id IS NULL) OR
    (board_id IS NULL AND event_deal_id IS NOT NULL)
  ),
  
  -- Thread depth limits
  CONSTRAINT reasonable_thread_depth CHECK (thread_depth <= 10)
);

-- Partnership address book for quick partner selection
CREATE TABLE partnerships (
  partnership_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
  partner_user_id UUID NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
  partnership_name TEXT, -- "Regular Tuesday Partners", etc.
  notes TEXT,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  
  -- Prevent self-partnerships and duplicates
  CONSTRAINT no_self_partnership CHECK (user_id != partner_user_id),
  UNIQUE (user_id, partner_user_id)
);

-- User preferences and settings
CREATE TABLE user_preferences (
  user_preference_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
  preference_key TEXT NOT NULL,
  preference_value JSONB NOT NULL,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE (user_id, preference_key)
);

-- Feature flags for controlled rollouts
CREATE TABLE feature_flags (
  feature_flag_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  flag_name TEXT UNIQUE NOT NULL,
  description TEXT,
  is_enabled BOOLEAN DEFAULT FALSE,
  target_users UUID[], -- NULL means all users
  target_user_types TEXT[], -- NULL means all types
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- Audit logging for administrative actions
CREATE TABLE audit_logs (
  audit_log_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(user_id),
  action TEXT NOT NULL,
  resource_type TEXT NOT NULL, -- 'user', 'game', 'event', 'comment', etc.
  resource_id UUID,
  old_values JSONB,
  new_values JSONB,
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMPTZ DEFAULT now()
);

-- Performance and query optimization indexes
CREATE INDEX idx_event_deals_event_board ON event_deals(event_id, board_number);
CREATE INDEX idx_boards_game_board ON boards(game_id, board_number);
CREATE INDEX idx_boards_event_deal ON boards(event_deal_id) WHERE event_deal_id IS NOT NULL;
CREATE INDEX idx_games_event ON games(event_id) WHERE event_id IS NOT NULL;
CREATE INDEX idx_games_owner_date ON games(owner_user_id, date DESC);
CREATE INDEX idx_games_club_date ON games(club_id, date DESC) WHERE club_id IS NOT NULL;
CREATE INDEX idx_event_results_lookup ON event_results(event_id, board_number);
CREATE INDEX idx_event_results_pair ON event_results(event_id, pair_number) WHERE pair_number IS NOT NULL;
CREATE INDEX idx_comments_event_deal_created ON comments(event_deal_id, created_at DESC) WHERE event_deal_id IS NOT NULL;
CREATE INDEX idx_comments_board_created ON comments(board_id, created_at DESC) WHERE board_id IS NOT NULL;
CREATE INDEX idx_comments_user_created ON comments(user_id, created_at DESC);
CREATE INDEX idx_partnerships_user ON partnerships(user_id) WHERE is_active = TRUE;
CREATE INDEX idx_game_participants_game ON game_participants(game_id);
CREATE INDEX idx_game_participants_user ON game_participants(user_id) WHERE user_id IS NOT NULL;
CREATE INDEX idx_events_club_date ON events(club_id, date DESC) WHERE club_id IS NOT NULL;
CREATE INDEX idx_events_status_date ON events(status, date DESC);

-- Full-text search indexes for content discovery
CREATE INDEX idx_events_search ON events USING gin(to_tsvector('english', name || ' ' || COALESCE(description, '')));
CREATE INDEX idx_games_search ON games USING gin(to_tsvector('english', name || ' ' || COALESCE(description, '')));
CREATE INDEX idx_comments_search ON comments USING gin(to_tsvector('english', body));
```

---

## 6) Enhanced API Contract

### 6.1 Authentication
- Bearer token with Firebase ID token in `Authorization` header
- Backend verifies token and derives user identity and permissions
- Role-based access control based on user type and game participation

### 6.2 Complete API Endpoints

```
# Authentication and user management
GET    /api/me                                  -> current user profile and preferences
PATCH  /api/me                                  -> update profile (display_name, home_club, preferences)
GET    /api/users?search=                       -> search users for partnerships
POST   /api/users/{userId}/partnerships         -> add user to partnership address book
DELETE /api/users/{userId}/partnerships/{partnerId} -> remove partnership

# Club management
GET    /api/clubs?search=&country=&state=       -> search and filter clubs
POST   /api/clubs                               -> create club (admin only)
PATCH  /api/clubs/{clubId}                      -> update club (admin/club admin)
DELETE /api/clubs/{clubId}                      -> deactivate club (admin only)
POST   /api/clubs/{clubId}/favorites            -> add club to user favorites
DELETE /api/clubs/{clubId}/favorites            -> remove club from favorites

# Enhanced event management
GET    /api/events?club_id=&type=&status=       -> list and filter events
POST   /api/events                              -> create event (club admin/admin)
PATCH  /api/events/{eventId}                    -> update event properties
POST   /api/events/{eventId}/publish            -> publish event for adoption
POST   /api/events/{eventId}/close              -> close event to new registrations
POST   /api/events/{eventId}/pbn                -> upload PBN to create event deals
GET    /api/events/{eventId}/deals              -> get all deals for event
PATCH  /api/events/{eventId}/deals/{boardNumber} -> update specific deal (propagates to games)
GET    /api/events/{eventId}/results            -> get comparative results across participants
GET    /api/events/{eventId}/standings          -> get leaderboard (formal or anonymous)
GET    /api/events/{eventId}/adoption           -> view adoption statistics
GET    /api/events/{eventId}/discussions        -> get event-level comments and discussions

# Flexible game creation and management
POST   /api/events/{eventId}/games              -> create game from event (flexible registration)
GET    /api/games                               -> list user's games (with optional filters)
POST   /api/games                               -> create standalone game
GET    /api/games/{gameId}                      -> get game details with participants
PATCH  /api/games/{gameId}                      -> update game properties
DELETE /api/games/{gameId}                      -> soft delete game
POST   /api/games/{gameId}/pbn                  -> upload PBN for standalone game
POST   /api/games/{gameId}/boards/trim          -> trim boards (with protection for user data)
POST   /api/games/{gameId}/results/submit       -> submit results to event (if linked)

# Participant management
GET    /api/games/{gameId}/participants         -> list game participants
POST   /api/games/{gameId}/participants         -> add participant to game
PATCH  /api/games/{gameId}/participants/{participantId} -> update participant role/permissions
DELETE /api/games/{gameId}/participants/{participantId} -> remove participant

# Board analysis and management
GET    /api/games/{gameId}/boards               -> list boards (auto-merges event deal data)
GET    /api/boards/{boardId}                    -> get board details (merged event + game data)
PATCH  /api/boards/{boardId}                    -> update bidding, contract, results, notes
GET    /api/boards/{boardId}/comparative        -> get results from other games on same deal
POST   /api/boards/{boardId}/analysis           -> submit detailed analysis
GET    /api/boards/{boardId}/optimal            -> get optimal play analysis (from PBN)

# Enhanced comment system
POST   /api/boards/{boardId}/comments           -> add board-specific comment
GET    /api/boards/{boardId}/comments           -> list board comments (with filters)
POST   /api/deals/{eventDealId}/comments        -> add event-wide deal comment
GET    /api/deals/{eventDealId}/comments        -> get event-level comments
PATCH  /api/comments/{commentId}                -> edit comment (owner only)
DELETE /api/comments/{commentId}                -> soft delete comment
POST   /api/comments/{commentId}/flag           -> flag comment for moderation

# Partnership and collaboration
GET    /api/partnerships                        -> list user's partnership address book
POST   /api/partnerships                        -> add partnership
DELETE /api/partnerships/{partnershipId}       -> remove partnership
GET    /api/partnerships/{partnerId}/games     -> games played with specific partner
GET    /api/partnerships/{partnerId}/stats     -> partnership performance statistics

# Search and discovery
GET    /api/search/events?q=                    -> search events by name/description
GET    /api/search/games?q=                     -> search games by name/description  
GET    /api/search/deals?tags=&difficulty=      -> search deals by characteristics
GET    /api/search/comments?q=                  -> search comments by content

# Analytics and statistics
GET    /api/analytics/user                      -> personal performance analytics
GET    /api/analytics/partnership/{partnerId}  -> partnership analytics
GET    /api/analytics/event/{eventId}          -> event participation analytics
GET    /api/analytics/deals/popular            -> most analyzed deals
GET    /api/analytics/performance/trends       -> performance trends over time

# Administrative endpoints
GET    /api/admin/users?search=&type=           -> admin user management
PATCH  /api/admin/users/{userId}               -> admin update user (role, status, etc.)
GET    /api/admin/clubs                        -> admin club management
GET    /api/admin/events                       -> admin event oversight
GET    /api/admin/games/flagged                -> admin review flagged games
GET    /api/admin/comments/flagged             -> admin review flagged comments
GET    /api/admin/analytics/usage              -> admin usage analytics
GET    /api/admin/integrity/check              -> admin data integrity check
POST   /api/admin/integrity/repair             -> admin automated data repair
GET    /api/admin/audit-logs                   -> admin audit trail
POST   /api/admin/feature-flags/{flag}/toggle  -> admin toggle feature flags
```

### 6.3 Enhanced API Examples

#### Create Post-Game Event (Casual Club Workflow):
```json
POST /api/events
{
  "name": "Friday Night Social - July 12",
  "description": "Relaxed bridge evening with interesting hands",
  "date": "2025-07-12",
  "club_id": "club-uuid",
  "kind": "casual_play",
  "registration_type": "open_registration", 
  "movement_type": "Casual",
  "enable_comparative_scoring": true,
  "allow_anonymous_games": true,
  "created_after_game": true,
  "game_completion_date": "2025-07-12"
}
```

#### Upload PBN to Create Shared Event Deals:
```json
POST /api/events/{eventId}/pbn
{
  "pbn_content": "[Event \"Friday Night Social\"]\n[Site \"Bridge Club\"]\n[Date \"2025.07.12\"]\n[Board \"1\"]\n...",
  "board_count": 24,
  "extract_optimal_results": true
}
```

#### Claim Participation in Casual Event:
```json
POST /api/events/{eventId}/games
{
  "session_identifier": "John and Mary - Table by the window",
  "direction": "NS",
  "participants": [
    { 
      "user_id": "user1-uuid", 
      "role": "owner", 
      "seat": "N",
      "is_editor": true 
    },
    { 
      "display_name": "Mary Jones", 
      "role": "player", 
      "seat": "S",
      "is_editor": false 
    }
  ]
}
```

#### Report Selective Board Results:
```json
PATCH /api/boards/{boardId}
{
  "bidding": [
    {"position": "N", "bid": "1S"}, 
    {"position": "E", "bid": "Pass"}, 
    {"position": "S", "bid": "2C"},
    {"position": "W", "bid": "Pass"},
    {"position": "N", "bid": "4S"},
    {"position": "E", "bid": "Pass"},
    {"position": "S", "bid": "Pass"},
    {"position": "W", "bid": "Pass"}
  ],
  "contract": "4S",
  "declarer": "N",
  "lead_card": "HT",
  "tricks_taken": 10,
  "score": 420,
  "notes": "Made exactly - lucky trump split",
  "bidding_notes": "Should I have bid 2S directly instead of 2C?",
  "is_analyzed": true,
  "analysis_quality": 3
}
```

#### Add Event-Wide Discussion Comment:
```json
POST /api/deals/{eventDealId}/comments
{
  "body": "This slam hand was makeable if you find the diamond finesse. Did anyone bid it?",
  "comment_type": "question",
  "visibility": "public"
}
```

#### Search for Similar Deals:
```json
GET /api/search/deals?tags=slam,competitive&difficulty=intermediate&hcp_range=20-24
```

---

## 7) Enhanced Workflows by Use Case

### 7.1 Formal Duplicate Club Workflow

#### 7.1.1 Pre-Game Setup (Traditional)
1. **Event Creation**: Club admin creates formal tournament event
   - Registration type: `formal_pairs`
   - Movement type: Mitchell/Howell
   - Pair registration enabled
2. **Hand Record Upload**: Upload PBN → creates shared event deals
3. **Publication**: Event published → available for pair registration

#### 7.1.2 Player Registration and Play
1. **Browse Events**: Players see formal tournament with pair registration
2. **Register**: Select available pair number and direction (NS/EW)
3. **Game Creation**: System creates game linked to event with pair/direction
4. **Add Partner**: Invite registered partner or add external partner name

#### 7.1.3 Post-Game Analysis
1. **Enter Results**: Players selectively report interesting boards
2. **Compare Results**: View how other pairs played same boards
3. **Discussion**: Board-specific and event-wide comments
4. **Leaderboard**: Traditional percentage-based standings

### 7.2 Casual Bridge Club Workflow

#### 7.2.1 Post-Game Event Creation (Recommended)
1. **Game Completion**: Club plays casual bridge session
2. **Event Creation**: Club admin creates post-game event
   - Registration type: `open_registration`
   - Created after game: `true`
   - Anonymous games: allowed
3. **Upload Hand Record**: Single PBN upload → shared deals for all participants

#### 7.2.2 Player Self-Registration
1. **Browse Available Events**: Players see casual session available
2. **Claim Participation**: Enter session identifier ("Table 3") or remain anonymous
3. **Add Partner**: Include partner name (registered user or free text)
4. **Flexible Timeline**: Players can join and report results at their own pace

#### 7.2.3 Learning-Focused Analysis
1. **Selective Reporting**: Players report results for boards they found interesting
2. **Community Learning**: See how others approached challenging hands
3. **Anonymous Comparison**: Compare results without pressure
4. **Discussion Focus**: Educational comments and questions

### 7.3 Bridge Teaching Workflow

#### 7.3.1 Lesson Preparation
1. **Create Teaching Event**: Instructor creates practice set
   - Event type: `teaching`
   - Registration: `invite_only`
   - Curated deals: specific learning objectives
2. **Upload Practice Hands**: PBN with educational focus
3. **Prepare Commentary**: Add deal-level teaching notes

#### 7.3.2 Student Engagement
1. **Student Registration**: Students adopt teaching event
2. **Practice Analysis**: Work through deals at own pace
3. **Submit Analysis**: Students report their bidding and play decisions
4. **Instructor Feedback**: Teacher comments on student approaches

#### 7.3.3 Collaborative Learning
1. **Group Discussions**: Event-wide comments visible to all students
2. **Peer Learning**: Students see different approaches from classmates
3. **Progress Tracking**: Instructor monitors student engagement and improvement

### 7.4 Individual Study Workflow

#### 7.4.1 Personal Practice
1. **Browse Archive**: Search for deals by characteristics (slam, competitive, etc.)
2. **Create Study Game**: Adopt interesting events for personal analysis
3. **Self-Analysis**: Work through bidding and play independently
4. **Compare Results**: See optimal play and community approaches

#### 7.4.2 Partnership Practice
1. **Invite Partner**: Add partner to practice game
2. **Collaborative Analysis**: Both partners enter their perspectives
3. **Discussion**: Private partnership comments
4. **Track Progress**: Monitor improvement over time

---

## 8) PBN Import Specification (Enhanced)

### 8.1 Event PBN Import (Shared Data Creation)

#### 8.1.1 Input Processing
- **Source**: Single PBN text/file with any number of boards
- **Target**: Creates `event_deals` records linked to event
- **Validation**: Format verification, encoding detection, size limits

#### 8.1.2 Data Extraction and Storage
- **Deal Data**: Hands, dealer, vulnerability extracted to `event_deals`
- **Optimal Analysis**: Par contracts, scores, double-dummy results
- **Hand Analysis**: HCP, distribution, shape computed once for efficiency
- **Raw Preservation**: Full PBN stored in `events.pbn_raw` for reference

#### 8.1.3 Enhanced Processing Features
- **Educational Tagging**: Automatic classification (slam, competitive, sacrifice)
- **Quality Assessment**: Deal difficulty and educational value scoring
- **Consistency Checks**: Validation against bridge rules and conventions
- **Error Recovery**: Graceful handling of malformed boards with detailed reporting

### 8.2 Standalone Game PBN Import

#### 8.1.1 Game-Specific Processing
- **Target**: Creates/updates `boards` records for specific game
- **User Data Protection**: Preserve existing bidding, contracts, results, notes
- **Selective Updates**: Only update deal data, never overwrite user analysis
- **Board Management**: Add missing boards, handle board count changes

#### 8.2.2 Data Integrity
- **Conflict Resolution**: Clear handling of PBN vs existing data conflicts
- **Backup Strategy**: Preserve user work before any PBN updates
- **Rollback Capability**: Ability to revert PBN imports if needed

### 8.3 Advanced Import Features

#### 8.3.1 Batch Processing and Performance
- **Chunked Processing**: Handle large PBN files efficiently
- **Progress Tracking**: Real-time feedback for long imports
- **Resource Management**: Memory-efficient processing of large datasets
- **Parallel Processing**: Optimize for multiple concurrent imports

#### 8.3.2 Error Handling and Recovery
- **Detailed Validation**: Comprehensive PBN format checking
- **Partial Import Support**: Continue processing after recoverable errors
- **Error Reporting**: Clear feedback on specific failures with board numbers
- **Auto-Repair**: Fix common PBN formatting issues automatically

### 8.4 Import Workflow Integration

#### 8.4.1 Event Creation Flow
1. **Create Event** → Set basic properties
2. **Upload PBN** → Process and create event_deals
3. **Review Results** → Verify boards, fix any issues  
4. **Publish Event** → Make available for adoption

#### 8.4.2 Game Enhancement Flow
1. **Create Game** → Basic game with placeholder boards
2. **Upload PBN** → Populate deal data while preserving user work
3. **Trim/Adjust** → Adjust board count, remove incomplete boards
4. **Continue Analysis** → Resume user data entry and analysis

---

## 9) User Experience Specifications

### 9.1 Event Discovery and Selection

#### 9.1.1 Event Browsing Interface
- **Clear Registration Indicators**: Visual distinction between formal tournaments and casual sessions
- **Filter Options**: By club, date, event type, registration requirements
- **Adoption Statistics**: Show how many games created, participation levels
- **Preview Information**: Board count, difficulty level, educational tags

#### 9.1.2 Registration Flow Customization
- **Formal Events**: Pair number selection, direction choice, partner invitation
- **Casual Events**: Flexible session description, anonymous option
- **Teaching Events**: Student registration, instructor approval workflow
- **Practice Events**: Immediate access, optional partner collaboration

### 9.2 Game Creation and Management

#### 9.2.1 Flexible Game Setup
- **Event Adoption**: Streamlined flow based on event type
- **Participant Management**: Easy partner addition via address book
- **Permission Control**: Configurable edit rights and collaboration levels
- **Privacy Settings**: Game visibility and comment sharing options

#### 9.2.2 Progressive Enhancement
- **Minimal Viable Game**: Start with basic info, enhance over time
- **Incremental Data Entry**: Add boards, results, analysis at user pace
- **Collaborative Features**: Real-time updates when partners contribute
- **Archive Integration**: Easy access to historical games and analysis

### 9.3 Board Analysis Interface

#### 9.3.1 Unified Deal Display
- **Seamless Data Merging**: Event deals + game-specific data in single view
- **Optimal Results Integration**: Par contracts and double-dummy analysis
- **Hand Analysis Tools**: HCP, distribution, shape analysis
- **Visual Enhancements**: Suit colors, clear vulnerability indicators

#### 9.3.2 Analysis Tools and Features
- **Bidding Pad**: Mobile-optimized with strict legality checking
- **Result Entry**: Contract, declarer, tricks, score with validation
- **Note-Taking**: Multiple note types (bidding, play, learning points)
- **Comparative Analysis**: Side-by-side with optimal and community results

### 9.4 Discussion and Collaboration

#### 9.4.1 Multi-Level Comments System
- **Board-Specific**: Private partnership and game-specific discussions
- **Event-Wide**: Community discussions visible across all participants
- **Comment Types**: Analysis, questions, teaching, general discussion
- **Privacy Controls**: Granular visibility settings

#### 9.4.2 Learning and Teaching Support
- **Educational Threading**: Organized discussions around learning topics
- **Instructor Tools**: Teaching comments with special highlighting
- **Student Features**: Question submission, peer learning support
- **Knowledge Archive**: Searchable history of analysis and discussions

### 9.5 Mobile and Responsive Design

#### 9.5.1 In-Play Optimization
- **Fixed Controls**: Bidding pad stays in place during sequence entry
- **Touch-Friendly**: Large buttons, swipe gestures, haptic feedback
- **Offline Capability**: Enter results without internet connection
- **Quick Actions**: Common tasks accessible with minimal taps

#### 9.5.2 Cross-Device Synchronization
- **Real-Time Updates**: Changes reflected across devices immediately
- **Conflict Resolution**: Handle simultaneous edits gracefully
- **Progressive Web App**: App-like experience without installation
- **Performance Optimization**: Fast loading, efficient data usage

---

## 10) Security and Privacy Framework

### 10.1 Authentication and Authorization

#### 10.1.1 Firebase Integration
- **Secure Authentication**: Firebase Auth with multiple provider support
- **Token Validation**: Backend verification of all API requests
- **Session Management**: Automatic token refresh, secure logout
- **Account Recovery**: Secure password reset and account restoration

#### 10.1.2 Role-Based Access Control
- **User Types**: Player, club, teacher, admin, moderator with appropriate permissions
- **Game Permissions**: Owner, participant, viewer with configurable rights
- **Club Administration**: Club admin rights for event and member management
- **Feature Flags**: User-specific feature access control

### 10.2 Data Protection and Privacy

#### 10.2.1 Personal Data Handling
- **Minimal Data Collection**: Only collect necessary information
- **Consent Management**: Clear opt-in for data sharing and analytics
- **Right to Deletion**: Complete account and data removal capability
- **Data Export**: User access to their complete data archive

#### 10.2.2 Game and Comment Privacy
- **Granular Visibility**: Private, partnership, club, public options
- **Anonymous Participation**: Support for anonymous result submission
- **Content Control**: User control over comment visibility and sharing
- **Moderation Tools**: Community reporting and admin moderation

### 10.3 Platform Security

#### 10.3.1 API Security
- **Rate Limiting**: Prevent abuse with intelligent throttling
- **Input Validation**: Comprehensive sanitization and validation
- **SQL Injection Prevention**: Parameterized queries and ORM usage
- **CORS Configuration**: Proper cross-origin request handling

#### 10.3.2 Infrastructure Security
- **HTTPS Everywhere**: SSL/TLS for all connections
- **Database Security**: Encryption at rest and in transit
- **Regular Backups**: Automated backup with tested recovery procedures
- **Security Monitoring**: Logging and alerting for suspicious activity

---

## 11) Performance and Scalability

### 11.1 Database Optimization

#### 11.1.1 Query Performance
- **Strategic Indexing**: Optimized indexes for common query patterns
- **Connection Pooling**: Efficient database connection management
- **Query Optimization**: Minimize N+1 queries, optimize JOINs
- **Caching Strategy**: Redis caching for frequently accessed data

#### 11.1.2 Data Architecture Efficiency
- **Shared Event Data**: 90%+ reduction in storage for popular events
- **Denormalization**: Strategic denormalization for read performance
- **Archive Strategy**: Older data migration for performance maintenance
- **Partition Strategy**: Table partitioning for large datasets

### 11.2 Application Performance

#### 11.2.1 Frontend Optimization
- **React Query**: Intelligent caching and background updates
- **Code Splitting**: Lazy loading for reduced initial bundle size
- **Image Optimization**: Responsive images with modern formats
- **Service Workers**: Offline capability and background sync

#### 11.2.2 API Performance
- **Response Compression**: Gzip/Brotli compression for API responses
- **Pagination**: Efficient pagination for large datasets
- **Background Processing**: Async processing for heavy operations
- **CDN Integration**: Static asset delivery optimization

### 11.3 Scalability Planning

#### 11.3.1 Horizontal Scaling
- **Stateless API**: Enable horizontal API server scaling
- **Database Replication**: Read replicas for query performance
- **Load Balancing**: Intelligent traffic distribution
- **Microservices Ready**: Architecture supports service decomposition

#### 11.3.2 Growth Accommodation
- **Resource Monitoring**: Proactive monitoring and alerting
- **Auto-Scaling**: Automatic resource scaling based on demand
- **Performance Testing**: Regular load testing and optimization
- **Capacity Planning**: Data-driven infrastructure growth planning

---

## 12) Quality Assurance and Testing

### 12.1 Testing Strategy

#### 12.1.1 Automated Testing
- **Unit Tests**: Comprehensive coverage of business logic
- **Integration Tests**: API endpoint and database integration testing
- **End-to-End Tests**: Critical user workflow automation
- **Performance Tests**: Load testing and performance regression detection

#### 12.1.2 Manual Testing
- **User Acceptance Testing**: Real user scenario validation
- **Accessibility Testing**: WCAG compliance verification
- **Cross-Browser Testing**: Compatibility across browsers and devices
- **Security Testing**: Penetration testing and vulnerability scanning

### 12.2 Quality Metrics

#### 12.2.1 Code Quality
- **Code Coverage**: Maintain high test coverage standards
- **Static Analysis**: Automated code quality and security scanning
- **Code Reviews**: Peer review process for all changes
- **Documentation**: Comprehensive API and code documentation

#### 12.2.2 User Experience Metrics
- **Performance Monitoring**: Real user monitoring and alerting
- **Error Tracking**: Comprehensive error logging and analysis
- **User Feedback**: In-app feedback collection and analysis
- **Analytics**: User behavior analysis and optimization

---

## 13) Enhanced Acceptance Criteria

### 13.1 Core Platform Features
- **User Authentication**: Firebase integration with secure token handling
- **Club Management**: Create, manage, and discover clubs with proper permissions
- **Partnership System**: Address-book style partnership management for easy collaboration
- **Game Creation**: Both standalone and event-linked games with participant management

### 13.2 Enhanced Event System
- **Event Types**: Support formal tournaments, casual sessions, practice sets, and teaching events
- **Shared Data Architecture**: Single PBN upload creates shared event_deals referenced by all games
- **Flexible Registration**: Handle both formal pair registration and casual open registration
- **Post-Game Events**: Support creating events after games complete for casual clubs

### 13.3 Board Analysis and Learning
- **Unified Deal Display**: Seamless integration of event deal data with game-specific user data
- **Selective Reporting**: Players choose which boards to analyze and report results
- **Comparative Analysis**: View how others played the same boards with privacy options
- **Multi-Level Comments**: Support both board-specific and event-wide discussions

### 13.4 Real-World Workflow Support
- **Casual Club Workflow**: Minimal administration, post-game event creation, optional result sharing
- **Formal Tournament Workflow**: Traditional pair registration, competitive scoring, official results
- **Teaching Workflow**: Instructor tools, student management, guided learning discussions
- **Individual Study**: Personal analysis, partnership collaboration, community learning

### 13.5 Performance and Efficiency
- **Shared Event Data**: 90%+ storage reduction for popular events through single-instance deal storage
- **Query Performance**: Optimized database design with strategic indexes for common access patterns
- **Real-Time Updates**: Efficient propagation of changes across linked games and participants
- **Mobile Optimization**: Touch-friendly interfaces optimized for in-play usage

### 13.6 Privacy and Flexibility
- **Anonymous Participation**: Support anonymous result submission and comparison for comfortable learning
- **Granular Privacy**: Multiple visibility levels for games, comments, and personal data
- **Optional Engagement**: Players control their participation level without pressure
- **Community Learning**: Balance between individual privacy and community knowledge sharing

---

## 14) Future Enhancement Roadmap

### 14.1 Phase 2: Enhanced Community Features (6-8 months)
- **Advanced Club Management**: Member verification, official membership, club directories
- **Enhanced Event Features**: Templates, recurring sessions, automated movement generation
- **Subscription System**: Premium features with Stripe integration
- **Mobile Applications**: Native iOS/Android apps with offline capability

### 14.2 Phase 3: AI and Advanced Analysis (8-12 months)
- **AI Bidding Analysis**: Automated bidding suggestions and convention checking
- **Advanced Statistics**: Performance tracking, partnership compatibility analysis
- **Teaching Tools**: AI-powered learning recommendations and progress tracking
- **Real-Time Play**: Live synchronization between partners during play

### 14.3 Phase 4: Integration and Expansion (12+ months)
- **Scoring Software Integration**: Import from popular scoring systems
- **Masterpoint Integration**: Official tournament result reporting
- **International Support**: Multi-language support, regional conventions
- **Bridge Organization Partnerships**: Integration with national and regional bridge organizations

---

## 15) Technical Implementation Priorities

### 15.1 MVP Scope (Months 1–4)
The MVP will focus only on features required for individual players and their partners to create, review, and discuss games. Community, club, and advanced analytics will be deferred to later phases.

#### Core Features
1. **User Accounts**
   - Firebase authentication for registration, login, and profile management.

2. **Game Creation**
   - Create standalone games (not linked to events).
   - Upload PBN file directly into a game.
   - Boards auto-generated from the uploaded PBN.

3. **Board Review**
   - Display deal data (hands, dealer, vulnerability).
   - Enter and validate bidding sequences (with undo/clear).
   - Record results: contract, declarer, tricks taken, notes.

4. **Partner Collaboration**
   - Each game supports exactly one partner.
   - Board-level comments between partners.
   - Privacy: games are private by default, no external visibility.

5. **Basic UI/UX**
   - Mobile-first responsive design.
   - Simple navigation: Dashboard → Games → Boards → Discussion.

#### MVP Deliverables
- Firebase-based authentication system
- Standalone game creation
- PBN upload and parsing into boards
- Board view and bidding entry
- Partner assignment and collaboration
- Commenting system for each board
- Responsive, mobile-friendly UI

---

### 15.2 Phase 2: Community & Clubs (Months 4–8)
Expands functionality from personal games to shared events and community interaction.

#### Features
- Event system (formal and casual club sessions).
- Shared deal architecture: single PBN upload serves multiple games.
- Comparative results across participants.
- Event-wide discussions.
- Basic club admin tools: event creation, publishing, and PBN upload.

---

### 15.3 Phase 3: Learning & Analytics (Months 8–12)
Adds tools for education, improvement, and broader engagement.

#### Features
- Advanced analytics (performance tracking, partnership stats, trends).
- Teaching events: curated deals with instructor commentary.
- Deal archive with tagging and search (e.g. slam, competitive).
- Enhanced comments with privacy and visibility options.

---

### 15.4 Phase 4: Expansion & AI (12+ months)
Focus on scaling, intelligence, and integrations.

#### Features
- AI-driven bidding suggestions and convention checking.
- Integration with scoring software and masterpoint systems.
- Subscription/paywall for premium features.
- Native iOS/Android apps with offline capability.
- Multi-language and regional support.
